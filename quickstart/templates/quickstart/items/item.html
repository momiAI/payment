{% extends "quickstart/auth/baseAuth.html" %}
{% csrf_token %}
{% block title %}–¢–æ–≤–∞—Ä—ã{% endblock %}
{%block button%}
        <div class="header-cart">
                <a href="{% url 'quickstart:cart_view'%}" class="cart-link" title="–ö–æ—Ä–∑–∏–Ω–∞">
                    üõí –ö–æ—Ä–∑–∏–Ω–∞
                </a>
        </div>
{%endblock%}

{% block content %}
<div id="cart-notification" class="notification">
    –¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É üõí
</div>

<div class="items-toolbar">
    <h2>–ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤</h2>

    <div class="currency-selector">
        <label for="currency">–í–∞–ª—é—Ç–∞:</label>
        <select id="currency" name="currency">
                <option value="usd">$ USD</option>
                <option value="rub">‚ÇΩ RUB</option>
                <option value="eur">‚Ç¨ EUR</option>
        </select>
    </div>
</div>


<div class="product-grid">
    {% for item in items %}
        <div class="product-card" data-item-id = {{item.id}}>
                <div class="product-image">
                        <img src="{{item.image.url}}" alt="Product">
                </div>

                <div class="product-content">
                        <h3 class="product-title">{{item.name}}</h3>
                        <p class="product-description">
                        {{item.description}}
                </p>

                <div class="product-footer">
                        <span class="product-price" data-usd = {{item.price}}>{{item.price}} $</span>

                <div class="product-actions">
                        <button class="icon-button cart" title="–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É">
                        üõí
                        </button>
                        <button class="icon-button buy" title="–ö—É–ø–∏—Ç—å">
                        üí≥
                        </button>
                </div>
                </div>
                </div>
        </div>
    {% endfor %}
</div>

<div id="checkout-overlay" class="checkout-overlay">
    <div class="checkout-modal">
        <div class="loader"></div>
        <p>–ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –æ–ø–ª–∞—Ç—É‚Ä¶<br>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ</p>
    </div>
</div>
{% endblock %}

{%block script%} 
 <script type="text/javascript" >


        const rates = { usd: 1, eur: 0.93, rub: 75.2 };
        const iconCurrency = {usd : "$" , eur : "‚Ç¨" , rub : "‚ÇΩ" }
        const prices = document.querySelectorAll('.product-price');

        document.getElementById('currency').addEventListener('change', (e) => {
        const currency = e.target.value;
        prices.forEach(span => {
                const usd = parseFloat(span.dataset.usd);
                span.textContent = (usd * rates[currency]).toFixed(2) + ' ' + iconCurrency[currency];
        });
        });

        function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                        const cookies = document.cookie.split(';');
                        for (let cookie of cookies) {
                        cookie = cookie.trim();
                        if (cookie.startsWith(name + '=')) {
                                cookieValue = decodeURIComponent(
                                cookie.substring(name.length + 1)
                                );
                                break;
                        }
                        }
        }
        return cookieValue;
        }

        const csrftoken = getCookie('csrftoken');

        document.querySelectorAll('.icon-button.cart').forEach(btn => {
        btn.addEventListener('click', () => {
                const itemId = btn.closest('.product-card').dataset.itemId
                const notification = document.getElementById('cart-notification');

                notification.classList.add('show');

                setTimeout(() => {
                notification.classList.remove('show');
                }, 3000);
            fetch('/item/add/', {
                method : 'POST',
                headers : {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                },
                body : JSON.stringify({
                        item_id : itemId
                })
            })
        })
    })

    document.querySelectorAll('.icon-button.buy').forEach(btn => { 
    btn.addEventListener('click', () => {
        const itemId = btn.closest('.product-card').dataset.itemId;
        const notification = document.getElementById('cart-notification');
        const currencySelect = document.getElementById("currency");
        const selectedCurrency = currencySelect.value;
        const overlay = document.getElementById('checkout-overlay')

       
        fetch('/item/add/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({ item_id: itemId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.message === 'ok') {
                overlay.style.display = 'flex';
                return fetch('/checkout-session/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify({ 
                        item_ids: [itemId],
                        currency : selectedCurrency
                })
                });
            } else {
                alert("–¢–æ–≤–∞—Ä –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –∫–æ—Ä–∑–∏–Ω–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞ –æ—Ñ–æ—Ä–º–∏—Ç–µ –ø–ª–∞—Ç–µ–∂ —á–µ—Ä–µ–∑ –Ω–µ—ë.");
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.url) {
                window.location.href = data.url;
            } else {
                alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞");
            }
        })

    });
});
    </script> 
{%endblock%}